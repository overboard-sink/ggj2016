<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Demon Torch</title>
    <script type="text/javascript" src="/js/phaser.min.js"></script>
    <script type="text/javascript" src="/js/demon.js"></script>
    <script type="text/javascript" src="/js/torch.js"></script>

  </head>
  <body>
    <main id="main"></main>
    <script type="text/javascript">


      var game = new Phaser.Game(640, 1120, Phaser.AUTO, 'main', {
        preload: preload,
        create: create,
        update: update
      });

      var demon;
      var torches;
      var overlay;
      var door;

      function preload() {
        Demon.preload(game);
        Torch.preload(game);
        game.load.image('overlay', '/img/overlay.png');
        game.load.image('door_vert', '/img/door_vert.png');
      }

      function create() {
        demon = new Demon(game, 20, 20);
        game.world.add(demon);

        torches = game.add.group();
        game.physics.arcade.enable(torches);

        var torch = new Torch(game, 100, 100);
        torches.add(torch);        

        torch = new Torch(game, 200, 100);        
        torches.add(torch);

        torch = new Torch(game, 150, 200);        
        torches.add(torch);        

        overlay = game.add.sprite(100, 100, 'overlay', 0);
        overlay.visible = false;

        door = game.add.sprite(80, 0, 'door_vert', 0);
        door.alpha = 0.5;
        door.open = false;
        game.physics.arcade.enable(door);
      }

      function update() {

        // touching torches
        game.physics.arcade.overlap(demon, torches, function (a, b) {
          b.light();
        });

        // task complete
        overlay.visible = true;
        door.alpha = 1.0;
        door.open = true;
        for (var i = 0; i < torches.children.length; i++) {
          if (!torches.children[i].lit) {
            overlay.visible = false;
            door.alpha = 0.5;
            door.open = false;
          }
        }

        // exit room
        if (door.open) {
          game.physics.arcade.overlap(demon, door, function (a, b) {
            console.log('you left');
          });
        }
      }
    </script>
  </body>
</html>
