<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Demon Torch</title>
    <script type="text/javascript" src="/js/phaser.min.js"></script>

  </head>
  <body>
    <main id="main"></main>
    <script type="text/javascript">


      var game = new Phaser.Game(640, 1120, Phaser.AUTO, 'main', {
        preload: preload,
        create: create,
        update: update
      });

      var demon;
      var torches;
      var overlay;
      var door;

      function preload() {
        game.load.spritesheet('demon', '/img/demon_4facing.png', 64, 64);
        game.load.image('overlay', '/img/overlay.png');
        game.load.image('door_vert', '/img/door_vert.png');
        game.load.spritesheet('torch', '/img/torch.png', 32, 32);
      }

      function create() {
        demon = game.add.sprite(20, 20, 'demon', 0);
        demon.anchor.setTo(.5, .5);
        demon.animations.add('down', [0], 0);
        demon.animations.add('left', [1], 0);
        demon.animations.add('right', [2], 0);
        demon.animations.add('up', [3], 0);
        game.physics.arcade.enable(demon);

        torches = game.add.group();
        game.physics.arcade.enable(torches);

        var torch = game.add.sprite(100, 100, 'torch', 0);
        game.physics.arcade.enable(torch);
        torches.add(torch);
        torch.lit = false;

        torch = game.add.sprite(200, 100, 'torch', 0);
        game.physics.arcade.enable(torch);
        torches.add(torch);
        torch.lit = false;

        torch = game.add.sprite(150, 200, 'torch', 0);
        game.physics.arcade.enable(torch);
        torches.add(torch);
        torch.lit = false;

        overlay = game.add.sprite(100, 100, 'overlay', 0);
        overlay.visible = false;

        door = game.add.sprite(80, 0, 'door_vert', 0);
        door.alpha = 0.5;
        door.open = false;
        game.physics.arcade.enable(door);
      }

      function update() {

        // movement
        game.physics.arcade.moveToPointer(demon, 200);

        // animation
        var vel = demon.body.velocity;
        var anim = demon.animations;
        if (Math.abs(vel.x) > Math.abs(vel.y)) {
          if (vel.x > 0) {
            anim.play('right');
          } else if (vel.x < 0) {
            anim.play('left');
          }
        } else if (Math.abs(vel.x) < Math.abs(vel.y)) {
          if (vel.y > 0) {
            anim.play('down');
          } else if (vel.y < 0) {
            anim.play('up');
          }
        }

        // touching torches
        game.physics.arcade.overlap(demon, torches, function (a, b) {
          b.frame = 1;
          b.lit = true;
        });

        // task complete
        overlay.visible = true;
        door.alpha = 1.0;
        door.open = true;
        for (var i = 0; i < torches.children.length; i++) {
          if (!torches.children[i].lit) {
            overlay.visible = false;
            door.alpha = 0.5;
            door.open = false;
          }
        }

        // exit room
        if (door.open) {
          game.physics.arcade.overlap(demon, door, function (a, b) {
            console.log('you left');
          });
        }
      }
    </script>
  </body>
</html>
